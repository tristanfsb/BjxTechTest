@page "/products"
@using SharedLib.DTOs

@attribute [Authorize(Roles = "Admin, Regular")]

@inject Radzen.DialogService dialogService
@inject HttpClient httpClient

<PageTitle>Productos</PageTitle>

<RadzenStack>
    <div class="rz-display-flex rz-align-items-center"
        style="position: relative; width: 100%; height: 3rem; padding-right: 2rem;">
        <RadzenButton Click=@(() => OnAddClick()) Text="Crear producto" Icon="add_circle"
            ButtonStyle="ButtonStyle.Primary" style="margin-left: auto;" />

        <div style="position: absolute; left: 50%; transform: translateX(-50%);">
            <RadzenText TextStyle="TextStyle.H4">Productos</RadzenText>
        </div>
    </div>

    <div class="rz-display-flex rz-justify-content-center rz-align-items-center">
        <RadzenCard class="rz-shadow-6" Style="width: 100%; margin: 1rem;">
            <RadzenDataGrid @ref="productsGrid" AllowFiltering="false" FilterPopupRenderMode="PopupRenderMode.OnDemand"
                AllowPaging="true" PageSize="5" AllowSorting="false" Data="@products" TItem="ProductDetailDto">
                <Columns>
                    <RadzenDataGridColumn Width="50px" Title="ID" TextAlign="TextAlign.Center">
                        <Template Context="data">
                            @(products.IndexOf(data) + 1)
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn Title="Producto" Property="ProductDetailDto.ProductName">
                        <Template Context="product">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem"
                                AlignItems="AlignItems.Center">
                                <RadzenStack Gap="0">
                                    <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-0"> @product.ProductName
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn Title="Descripción" Property="ProductDetailDto.Description">
                        <Template Context="product">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem"
                                AlignItems="AlignItems.Center">
                                <RadzenStack Gap="0">
                                    <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-0"> @product.Description
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn Title="Stock" Property="ProductDetailDto.Stock">
                        <Template Context="product">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem"
                                AlignItems="AlignItems.Center">
                                <RadzenStack Gap="0">
                                    <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-0"> @product.Stock
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn Title="Código" Property="ProductDetailDto.Code">
                        <Template Context="product">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem"
                                AlignItems="AlignItems.Center">
                                <RadzenStack Gap="0">
                                    <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-0"> @product.Code
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>



                </Columns>
            </RadzenDataGrid>
        </RadzenCard>
    </div>
</RadzenStack>


@code {

    public required RadzenDataGrid<ProductDetailDto> productsGrid;
    public required IList<ProductDetailDto> products;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        products = await UpdateTable();
    }

    private async Task OnAddClick()
    {
        var parameters = new Dictionary<string, object>
            {
                { "OnProductCreated", EventCallback.Factory.Create(this, RefreshProducts)}
            };
        await dialogService.OpenAsync<CreateProductDialogPage>(
            "Crear Nuevo Producto",
            parameters,
            new DialogOptions() { Width = "900px", Height = "700px" });
    }

    private async Task RefreshProducts()
    {
        products = await UpdateTable();
        await productsGrid.Reload();
        StateHasChanged();
    }

    protected async Task<IList<ProductDetailDto>> UpdateTable()
    {
        try{
            var response = await httpClient.GetAsync("Products");
            if(response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<IList<ProductDetailDto>>();
                return result ?? new List<ProductDetailDto>();
            }else
            {
                return new List<ProductDetailDto>();
            }
        }   
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            return new List<ProductDetailDto>();
        }
    }
}

    